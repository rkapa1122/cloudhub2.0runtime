name: Update Mule Runtime on CloudHub 2.0 (Hardcoded)

on:
  workflow_dispatch:
    inputs:
      runtimeImage:
        description: "Mule runtime image (e.g. mulesoft/mule-runtime:4.9.11)"
        required: true
      appName:
        description: "runtimeautomation"
        required: true

jobs:
  update-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Get Anypoint Access Token
        run: |
          TOKEN=$(curl -s -X POST https://anypoint.mulesoft.com/accounts/api/v2/oauth2/token \
            -H "Content-Type: application/json" \
            -d '{
              "grant_type": "client_credentials",
              "client_id": "f6e58674681a44569abb7b1af1011a9f",
              "client_secret": "0C25F7CE451D4954986D8a532D71292F"
            }' | jq -r '.access_token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "ERROR: Failed to obtain access token"
            exit 1
          fi

          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Get Existing Deployment and Show Current Runtime
        run: |
          RESPONSE=$(curl -s -L -w "\n%{http_code}" -X GET \
            "https://anypoint.mulesoft.com/runtime-fabric/api/v1/deployments/${{ github.event.inputs.appName }}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "X-ANYPNT-ORG-ID: 438cc9b1-154d-4ca6-864a-4c41c21f3458" \
            -H "X-ANYPNT-ENV-ID: 7e607371-34c6-42e9-9e61-3344ed6d1186" \
            -H "Accept: application/json")

          BODY=$(echo "$RESPONSE" | head -n 1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "GET Deployment HTTP Status: $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo "ERROR: Failed to fetch deployment"
            echo "$BODY"
            exit 1
          fi

          echo "$BODY" > deployment.json

          CURRENT_IMAGE=$(jq -r '.spec.template.spec.containers[0].image' deployment.json)
          echo "Current Mule Runtime Image: $CURRENT_IMAGE"

      - name: Update Runtime Image and Redeploy
        run: |
          echo "Updating runtime image..."

          jq '.spec.template.spec.containers[0].image = "${{ github.event.inputs.runtimeImage }}"' \
            deployment.json > updated-deployment.json

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            "https://anypoint.mulesoft.com/runtime-fabric/api/v1/deployments/${{ github.event.inputs.appName }}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "X-ANYPNT-ORG-ID: 438cc9b1-154d-4ca6-864a-4c41c21f3458" \
            -H "X-ANYPNT-ENV-ID: 7e607371-34c6-42e9-9e61-3344ed6d1186" \
            -H "Content-Type: application/json" \
            --data-binary @updated-deployment.json)

          BODY=$(echo "$RESPONSE" | head -n 1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          echo "PUT Deployment HTTP Status: $STATUS"

          if [ "$STATUS" != "200" ] && [ "$STATUS" != "202" ]; then
            echo "ERROR: Redeploy failed"
            echo "$BODY"
            exit 1
          fi

          echo "Redeploy triggered successfully"
